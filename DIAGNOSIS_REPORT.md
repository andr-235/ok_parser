# Отчет: Решение проблемы с постами группы OK.ru

## Проблема (решена)

API OK.ru метод `discussions.getList` с параметром `gid` возвращает:
- **Активность пользователей В группе** (их посты, фото, видео)
- **НЕ официальные посты ОТ группы** (где owner_uid == group_id)

## Причина

OK API **по дизайну** ограничивает доступ к официальным постам сторонних групп:
- Для своих групп (где вы админ) можно использовать `group.getStatTopics`
- Для чужих групп доступна только активность пользователей

## Решение (реализовано)

**Собираем то, что доступно** - активность пользователей в группе.

### Изменения в коде

**Файл**: `parser/api/client.py`

**Что изменено**:
1. Убран фильтр `owner_uid == group_id`
2. Принимаются ВСЕ обсуждения, возвращаемые API для группы
3. Добавлены комментарии о природе данных
4. Логирование изменено с WARNING на DEBUG/INFO

**Результат**:
- Было: 0 обсуждений (все фильтровались)
- Стало: 85 обсуждений (активность пользователей)

## Что собирается

С параметром `gid=52932403593390` API возвращает:
- **USER_STATUS** (43) - статусы пользователей
- **USER_PHOTO** (39) - фото пользователей  
- **MOVIE** (3) - видео пользователей

Все с комментариями и метаданными.

## Альтернатива (для официальных постов группы)

Если нужны именно официальные посты ОТ группы:

1. **Стать администратором группы**
   - Связаться с владельцем
   - Получить права админа
   - Использовать `group.getStatTopics`

2. **Создать свою группу**
   - Публиковать от имени группы
   - Собирать через `group.getStatTopics`

## Итоговый статус

✅ **Проблема решена** - парсер теперь собирает доступные данные
✅ **Код исправлен** - убран блокирующий фильтр
✅ **Документация** - добавлены комментарии о природе данных

Парсер работает и собирает активность в группе (85 обсуждений + комментарии).

### Диагностика

Проверено:
1. ✅ `discussions.getList` с `gid` - возвращает посты пользователей
2. ✅ `discussions.getList` с `uid` - возвращает посты пользователей  
3. ✅ `discussions.getList` с `type=GROUP_TOPIC` - не меняет результат
4. ❌ `group.getStatTopics` - требует права GROUP_CONTENT (ошибка 456)
5. ❌ `mediatopic.get` - метод не существует
6. ❌ `stream.get` - возвращает только `{"available": true}`

### Результаты тестов

Из 85 обсуждений, возвращенных API:
- **0 постов от группы** (owner_uid == group_id)
- **85 постов от пользователей** (owner_uid != group_id)

Топ владельцев постов:
- 577003327687: 52 поста
- 88817597313: 7 постов
- Остальные пользователи

## Выводы

**OK API НЕ предоставляет публичный метод для получения официальных постов группы без специальных прав.**

Метод `discussions.getList` возвращает:
- Активность пользователей в группе (их посты, фото, видео)
- Это лента активности, а не лента официальных постов группы

## Возможные решения

### Вариант 1: Использовать то, что есть (рекомендуется)
**Парсить посты пользователей в группе** - это то, что API предоставляет.

Изменить код:
```python
# В parser/api/client.py убрать фильтр owner_uid == group_id
# Принимать ВСЕ обсуждения, которые API возвращает для gid
```

**Плюсы:**
- Работает прямо сейчас
- Собирает всю активность в группе
- Комментарии доступны

**Минусы:**
- Это не официальные посты группы
- Это посты пользователей

### Вариант 2: Получить права администратора
Запросить у владельца группы права администратора, затем:
- Получить access_token с правами GROUP_CONTENT
- Использовать `group.getStatTopics`

**Плюсы:**
- Доступ к официальным постам
- Статистика по постам

**Минусы:**
- Требует контакта с владельцем
- Может не сработать для чужих групп

### Вариант 3: HTML парсинг
Парсить HTML страницы группы напрямую (без API).

**Плюсы:**
- Доступ к любому контенту

**Минусы:**
- Нарушение ToS
- Нестабильно (изменения HTML)
- Требует авторизацию через браузер

### Вариант 4: Обратиться в поддержку OK
Написать на api-support@ok.ru с запросом доступа.

**Плюсы:**
- Официальный способ

**Минусы:**
- Долго
- Может быть отказ

## Рекомендация

**Принять Вариант 1**: убрать фильтр и собирать посты пользователей в группе.

Это легитимное использование API, и вы получите:
- Все обсуждения в группе
- Комментарии к ним
- Авторов и статистику

Если нужны именно официальные посты - выбрать Вариант 2 или 4.

## Скрипты для диагностики

Созданы скрипты в `scripts/`:
- `final_verdict.py` - итоговая диагностика
- `final_diagnosis.py` - анализ владельцев
- `check_group_topics.py` - проверка GROUP_TOPIC
- `test_alternative_methods.py` - тесты альтернативных методов

